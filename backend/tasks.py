"""
Payslip Analysis Tasks - כל המשימות למערכת ניתוח תלושי שכר
"""
from crewai import Task
from agents import chatbot_manager, parser, validator, analyzer, designer, reporter


# ═══════════════════════════════════════════════════════════════════
# 📄 Parse Task - משימת חילוץ נתונים
# ═══════════════════════════════════════════════════════════════════

parse_task = Task(
    description="""חלץ את כל המידע מתלוש השכר:
    1. פרטי עובד: שם מלא, ת.ז, תפקיד
    2. תקופת שכר: חודש ושנה
    3. נתוני שכר: משכורת בסיס, משכורת ברוטו, משכורת נטו
    4. תוספות: שעות נוספות, בונוסים, תוספות אחרות
    5. ניכויים: מס הכנסה, ביטוח לאומי, פנסיה, בריאות

    קובץ תלוש: {payslip_file}
    """,
    expected_output="""JSON מובנה:
    {
        "employee": {"name": "...", "id": "...", "role": "..."},
        "period": {"month": "...", "year": "..."},
        "salary": {"base": 0, "gross": 0, "net": 0},
        "additions": [{"type": "...", "amount": 0}],
        "deductions": [{"type": "...", "amount": 0}]
    }""",
    agent=parser
)


# ═══════════════════════════════════════════════════════════════════
# ✅ Validate Task - משימת אימות
# ═══════════════════════════════════════════════════════════════════

validate_task = Task(
    description="""אמת את כל החישובים בתלוש:
    1. ברוטו = בסיס + סכום כל התוספות
    2. נטו = ברוטו - סכום כל הניכויים
    3. שיעורי ניכויים: מס (10-50%), ביטוח לאומי (~12%), פנסיה (~18.5%)
    4. טווחים: בדוק שהמספרים הגיוניים

    השתמש בנתונים שחולצו על ידי Parser.
    """,
    expected_output="""דוח אימות:
    ✅ חישובים תקינים / ⚠️ בעיות שנמצאו:
    - ברוטו: תקין/שגוי (הפרש: X ₪)
    - נטו: תקין/שגוי (הפרש: X ₪)
    - ניכויים: תקינים/חריגים
    - רשימת כל השגיאות שנמצאו""",
    agent=validator
)


# ═══════════════════════════════════════════════════════════════════
# 📊 Analyze Task - משימת ניתוח
# ═══════════════════════════════════════════════════════════════════

analyze_task = Task(
    description="""נתח את התלוש ביחס לתלושים קודמים:
    1. השווה שכר נטו לחודשים קודמים
    2. זהה שינויים בתוספות (הופיעו/נעלמו)
    3. זהה שינויים בניכויים (הופיעו/נעלמו)
    4. חפש חריגות: שינויים >15%, ערכים חריגים

    אם זה התלוש הראשון - ציין זאת.
    קובץ היסטוריה: {history_file}
    """,
    expected_output="""דוח ניתוח:
    📊 השוואה לחודש קודם:
    - שכר נטו: עלה/ירד ב-X% (X ₪)
    - תוספות חדשות: [רשימה]
    - תוספות שנעלמו: [רשימה]
    - ניכויים חדשים: [רשימה]
    - חריגות: [רשימת אנומליות]""",
    agent=analyzer
)


# ═══════════════════════════════════════════════════════════════════
# 📑 Report Task - משימת דיווח
# ═══════════════════════════════════════════════════════════════════

report_task = Task(
    description="""צור דוח מקיף בעברית עם:
    1. סיכום ראשי: עובד, תקופה, שכר נטו
    2. פירוט שכר: בסיס, תוספות, ניכויים
    3. בעיות שנמצאו (מה-Validator)
    4. שינויים וחריגות (מה-Analyzer)
    5. המלצות לפעולה

    השתמש באימוג'י: ✅ (תקין), ⚠️ (אזהרה), 🔴 (בעיה)
    פורמט: Markdown מעוצב בעברית
    """,
    expected_output="""# דוח ניתוח תלוש שכר

    ## 📋 סיכום ראשי
    - עובד: [שם]
    - תקופה: [חודש/שנה]
    - שכר נטו: [סכום] ₪

    ## 💰 פירוט שכר
    [טבלה מפורטת]

    ## ⚠️ בעיות שנמצאו
    [רשימה]

    ## 📊 שינויים וחריגות
    [רשימה]

    ## 💡 המלצות
    [רשימה]""",
    agent=reporter
)


# ═══════════════════════════════════════════════════════════════════
# 📊 Monthly Analysis Task - משימת ניתוח חודשי
# ═══════════════════════════════════════════════════════════════════

monthly_analysis_task = Task(
    description="""בצע ניתוח מקיף לכל התלושים בחודש {month}/{year}:

    1. 💰 עובד עם השכר הגבוה ביותר בכל מחלקה:
       - קבץ את כל התלושים לפי מחלקות
       - מצא את העובד עם השכר הגבוה ביותר בכל מחלקה
       - **שים לב**: השכר = final_payment (סכום לתשלום/נטו), לא gross/ברוטו!
       - נתיב לנתון: parsed_data.salary.final_payment או parsed_data.final_payment
       - כלול: מחלקה, שם עובד, מספר עובד, שכר (final_payment)

    2. 🏖️ 3 עובדים עם ימי החופש הגבוהים ביותר:
       - מיין את כל העובדים לפי vacation_days
       - נתיב לנתון: parsed_data.vacation_account.current_vacation_balance או parsed_data.vacation_days
       - החזר את 3 העליונים
       - כלול: דירוג (#1, #2, #3), שם עובד, מספר עובד, ימי חופש

    3. ⚠️ זיהוי אנומליות - כל עובד שעומד באחד מהתנאים הבאים:

       **כללים**:
       א. שכר גבוה: final_payment מעל ₪16,000
          - שדה: parsed_data.salary.final_payment
          - סוג אנומליה: "שכר גבוה"
          - ערך: ה-final_payment בפועל

       ב. נסיעות גבוהות: travel_allowance מעל ₪300
          - שדה: parsed_data.additional_payments.travel_allowance
          - סוג אנומליה: "נסיעות גבוהות"
          - ערך: ה-travel_allowance בפועל

       ג. פרמיה גבוהה: premium מעל ₪100
          - שדה: parsed_data.additional_payments.premium
          - סוג אנומליה: "פרמיה גבוהה"
          - ערך: ה-premium בפועל

       **חשוב**:
       - הצג את כל העובדים שעומדים בתנאים (לא מוגבל ל-3)
       - עובד אחד יכול להופיע פעם אחת בלבד עם האנומליה החמורה ביותר
       - אם אין אנומליות כלל - החזר רשימה ריקה []
       - כל אנומליה צריכה כותרת ברורה (סוג האנומליה)

       כלול: שם עובד, מספר עובד, סוג אנומליה, ערך (הערך המדויק של השדה)

    **חשוב**: השתמש בפונקציות הקיימות שלך:
    - create_kpi() ליצירת KPIs מותאמים אישית
    - detect_anomalies() לזיהוי חריגות סטטיסטיות
    - analyze_trend() לניתוח מגמות

    נתונים זמינים: {payslips_data}
    """,
    expected_output="""JSON מובנה עם 3 חלקים:
    {
        "highest_salary_per_department": {
            "מחלקה 1": {"employee_name": "...", "employee_id": "...", "salary": 0},
            "מחלקה 2": {...}
        },
        "top_vacation_days": [
            {"rank": 1, "employee_name": "...", "employee_id": "...", "vacation_days": 0},
            {"rank": 2, ...},
            {"rank": 3, ...}
        ],
        "anomalies": [
            {"employee_name": "...", "employee_id": "...", "anomaly_type": "שכר גבוה", "value": 0},
            {"employee_name": "...", "employee_id": "...", "anomaly_type": "נסיעות גבוהות", "value": 0},
            {"employee_name": "...", "employee_id": "...", "anomaly_type": "פרמיה גבוהה", "value": 0}
        ]
    }""",
    agent=analyzer
)


# ═══════════════════════════════════════════════════════════════════
# 🎨 Monthly Design Task - משימת עיצוב דוח חודשי
# ═══════════════════════════════════════════════════════════════════

monthly_design_task = Task(
    description="""עצב דוח ניתוח חודשי HTML מנתוני Analyzer לחודש {month}/{year}:

    **קלט שקיבלת מה-Analyzer**:
    {analysis_data}

    **המשימה שלך**:
    קח את נתוני ה-JSON ועצב דוח HTML מושלם עם:

    1. **כותרת ראשית**:
       <h3>ניתוח לחודש {month}/{year}</h3>
       <p>סה"כ {total_payslips} תלושים</p>

    2. **3 טבלאות מעוצבות**:

       **טבלה 1**: 💰 עובד עם שכר גבוה ביותר בכל מחלקה
       מקור נתונים: highest_salary_per_department
       עמודות: מחלקה | שם עובד | מספר עובד | שכר

       **טבלה 2**: 🏖️ 3 עובדים עם ימי חופש גבוהים
       מקור נתונים: top_vacation_days
       עמודות: # | שם עובד | מספר עובד | ימי חופש

       **טבלה 3**: ⚠️ אנומליות
       מקור נתונים: anomalies
       עמודות: שם עובד | מספר עובד | סוג אנומליה | ערך
       **חשוב**: אם אין אנומליות (רשימה ריקה) - אל תציג את הטבלה הזו בכלל!

    **כללי עיצוב**:
    - כל טבלה: <div class="summary-card"><h4>אימוג'י כותרת</h4><table class="payslips-table">...</table></div>
    - מספרים כספיים: <td class="salary">₪XX,XXX.XX</td>
    - שמות עובדים: <td class="employee-name">שם</td>
    - מספרים רגילים: <td>123</td>
    - אם אין נתונים: <p style="text-align: center; color: var(--text-secondary); padding: 1rem;">לא נמצאו X</p>

    **חשוב**: תן רק HTML! בלי הסברים, רק הקוד.
    """,
    expected_output="""<div style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1.5rem; font-size: 1.5rem;">ניתוח לחודש 10/2024</h3>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">סה"כ 23 תלושים</p>

    <div class="summary-card" style="margin-bottom: 2rem;">
        <h4 style="font-size: 1.125rem; margin-bottom: 1rem; color: #8B7355;">💰 עובד עם השכר הגבוה ביותר בכל מחלקה</h4>
        <div class="payslips-table-container">
            <table class="payslips-table">
                <thead>
                    <tr>
                        <th>מחלקה</th>
                        <th>שם עובד</th>
                        <th>מספר עובד</th>
                        <th>שכר</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>002 טבחים</td>
                        <td class="employee-name">יוסי כהן</td>
                        <td>12345</td>
                        <td class="salary">₪15,000.00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    [3 טבלאות נוספות...]
</div>""",
    agent=designer
)

# Backward compatibility
monthly_report_task = monthly_design_task


# ═══════════════════════════════════════════════════════════════════
# 💬 Chatbot Coordination Task - משימת תיאום הצ'אטבוט
# ═══════════════════════════════════════════════════════════════════

chatbot_coordination_task = Task(
    description="""אתה מנהל AI שיחתי שמתאם בין 4 סוכנים מומחים.

    **הסוכנים שלך**:
    1. 📄 Parser - מחלץ נתונים מ-PDF
    2. ✅ Validator - בודק חישובים
    3. 📊 Analyzer - מנתח נתונים, יוצר KPIs, מזהה אנומליות
    4. 🎨 Designer - מעצב דוחות HTML וגרפים

    **קלט משתמש**: {user_question}
    **קונטקסט**: {context}

    **המשימה שלך**:
    1. הבן מה המשתמש רוצה
    2. החלט אילו סוכנים צריכים לעבוד
    3. תאם את העבודה ביניהם
    4. החזר תשובה מלאה ומעוצבת

    **דוגמאות**:
    - "תנתח את התלוש" → Parser → Validator → Analyzer → Designer
    - "מי העובד עם השכר הכי גבוה?" → Analyzer (create_kpi)
    - "תן לי גרף של שכרים" → Analyzer → Designer (עם chart_tool)
    - "יש טעות בתלוש?" → Parser → Validator

    **חשוב**:
    - השתמש בפונקציות המתקדמות של Analyzer: create_kpi(), analyze_trend(), detect_anomalies()
    - בקש מ-Designer לעצב עם גרפים כשמתאים
    - למד מכל תשובה - אילו סוכנים עבדו טוב, איך לשפר
    """,
    expected_output="""תשובה מלאה למשתמש:
    - אם שאלה על נתונים → מספרים + הסבר
    - אם ניתוח → HTML מעוצב עם טבלאות/גרפים
    - אם שגיאות → רשימת בעיות + המלצות
    - תמיד בעברית, ברור, עם אימוג'י""",
    agent=chatbot_manager
)
